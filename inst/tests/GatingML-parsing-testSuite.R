context("parse gatingMLs exported from Cytobank ")

path <- "~/rglab/workspace/flowWorkspace/wsTestSuite/gatingML"

test_that("gatingML-cytobank parsing: custom comp and gates with prefixed channels ",{
      thisPath <- file.path(path, "ics")
      #load the original automated gating set
      gs_orig <- load_gs(file.path(thisPath, "autogating")) 
      gt <- openCyto::gatingTemplate(file.path(thisPath, "template/gt_080.csv"))
      flowIncubator::toggle.helperGates(gt, gs_orig) #hide the helper gates
      stats <- getPopStats(gs_orig)[order(Population),]
      
      #export the gs_orig to xml
      tmp <- tempfile()
      flowIncubator::GatingSet2GatingML(gs_orig, tmp)
      
      #parse the exported xml
      fcs <- file.path(path, "ics/769121.fcs")
      gs_parsed <- parse.gatingML(tmp, fcs)
      
      parsedStats <- getPopStats(gs_parsed)[order(Population),]
      expect_equal(stats, parsedStats, tol = 2e-4)
      
      #upload xml to cytobank and download the cytobank version of xml
      
      #parse the cytobank xml 
      xmlfile <- file.path(path, "ics/CytExp_52926_Gates_v5.xml")
      gs_parsed <- parse.gatingML(xmlfile, fcs)
      
      parsedStats <- getPopStats(gs_parsed)[order(Population),]
      expect_equal(stats, parsedStats, tol = 2e-4)
      
    })


test_that("gatingML-cytobank parsing: no transformations",{
  xmlfile <- file.path(path, "no_trans.xml")
  g <- read.gatingML.cytobank(xmlfile)
  expect_is(g, "graphGML")
  expect_null(getTransformations(g))
})

test_that("gatingML-cytobank parsing: cytotrol tcell",{
  xmlfile <- system.file("extdata/cytotrol_tcell_cytobank.xml", package = "flowWorkspace")
  fcsFiles <- list.files(pattern = "CytoTrol", system.file("extdata", package = "flowWorkspaceData"), full = T)
  gs <- parse.gatingML(xmlfile, fcsFiles)
  
  
  #' ## verify the stats are correct
  statsfile <- system.file("extdata/cytotrol_tcell_cytobank_counts.csv", package = "flowWorkspace")
  dt_merged <- compare.counts(gs, statsfile, id.vars = "population")
  
  
  expect_equal(dt_merged[, count.x], dt_merged[, count.y], tol = 5e-4)
  
  
  
})

test_that("gatingML-cytobank parsing: Merck FirstExample",{
  thisPath <- file.path(path, "Merck/firstExample")
  xmlfile <- file.path(thisPath, "CytExp_10623_Gates_v5.xml")
  fcsFiles <- list.files(pattern = "\\.fcs", thisPath, full = T)
  gs <- parse.gatingML(xmlfile, fcsFiles[c(1,3,6)])
  
  ### Verify the stats are correct
  statsfile <- file.path(thisPath,"population_counts.csv")
  dt_merged <- compare.counts(gs, statsfile)
  
  unequaled <- dt_merged[count.x != count.y]
  expect_equal(nrow(unequaled), 0)
})

test_that("gatingML-cytobank parsing: Merck SecondExample",{
  thisPath <- file.path(path, "/Merck/SecondExample")
  xmlfile <- file.path(thisPath, "CytExp_10624_Gates_v3.xml")
  fcsFiles <- list.files(pattern = "\\.fcs", thisPath, full = T)
  
  gs <- parse.gatingML(xmlfile, fcsFiles[c(1,4,6,12)])
  
  ### Verify the stats are correct
  statsfile <- file.path(thisPath,"secondExample.csv")
  dt_merged <- compare.counts(gs, statsfile, id.vars = "population") #subset the files to speed up testing
  
  
  unequaled <- dt_merged[count.x != count.y]
  expect_equal(nrow(unequaled), 0)
})
